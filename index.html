<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영웅전설: 가가브 트릴로지</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-37K1C9W7BK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-37K1C9W7BK');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
    <style>
        /* ... 이전 CSS와 대부분 동일 ... */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            color: #e0e0e0;
            position: relative;
            overflow-y: scroll;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-family: 'Poppins', sans-serif;
            font-size: 2.5em;
            color: #ff4081;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.2);
            position: relative;
            z-index: 1;
        }
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px,1fr));
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        .character-box {
            background: rgba(26,26,26,0.2);
            border: none;
            padding: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s, z-index 0s 0.3s;
            position: relative;
            height: 160px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1;
        }
        .character-box.rare {
            border: 2px solid #ff9800;
            box-shadow: 0 0 15px rgba(255,152,0,0.5), 0 4px 12px rgba(255,152,0,0.7);
        }
        .character-box.super-rare {
            border: 2px solid #D32F2F;
            box-shadow: 0 0 15px rgba(211, 47, 47, 0.5), 0 4px 12px rgba(211, 47, 47, 0.7);
        }
        .character-box.selected {
            background-color: rgba(255,64,129,0.9);
            box-shadow: 0 0 20px rgba(255,64,129,0.7), 0 8px 20px rgba(255,64,129,0.8);
            transform: translateY(-5px);
            z-index: 2;
        }
        .character-box::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://www.transparenttextures.com/patterns/gplay.png') repeat;
            opacity: 0.5;
            border-radius: 15px;
            pointer-events: none;
            z-index: 0;
        }
        .character-box > * {
            position: relative;
            z-index: 1;
        }
        @media (hover: hover) and (pointer: fine) {
            .character-box:hover {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255,255,255,0.2);
                z-index: 10;
            }
            .result-item:hover {
				background: linear-gradient(135deg, #33363d, #2a2c30);
				box-shadow: 0 6px 25px rgba(0,0,0,0.7), 0 0 10px rgba(255, 64, 129, 0.4);
				transform: translateY(-3px);
				border-color: rgba(255, 64, 129, 0.5);
			}
			.result-item:hover::before {
				opacity: 1;
			}
			.extras-box:hover {
				background: rgba(176, 176, 176, 0.2);
				border-color: rgba(176, 176, 176, 0.8);
			}
        }
        .character-img {
            width: 80px;
            height: 90px;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 10px;
            transition: transform 0.3s;
        }
        .character-name {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 700;
            color: #fff;
        }
        .spinbox-container {
            width: 80%;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s, transform 0.3s;
            justify-content: center;
            margin-top: -5px;
            transform: translateY(-10px);
        }
        .character-box.selected .spinbox-container {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .spinbox-container input[type="number"] {
            width: 50px;
            padding: 5px;
            border: 1px solid #555;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .spinbox-container input[type="number"]:focus {
            border-color: #ff4081;
            box-shadow: 0 0 5px rgba(255,64,129,0.5);
            outline: none;
        }
        #filterButton {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px;
            margin: 25px 0;
            font-size: 18px;
            cursor: pointer;
            background: linear-gradient(45deg, #ff4081, #f50057);
            color: #fff;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 16px rgba(255,64,129,0.6);
            transition: background 0.3s, box-shadow 0.3s, transform 0.3s;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }
        #copyInstruction {
            margin-bottom: 15px;
            font-style: italic;
            color: #ff4081;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
        }
        #copyMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            display: none;
            opacity: 0;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1em;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #copyMessage.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* [수정] 가상 스크롤을 위한 컨테이너 스타일 */
        #results {
            padding: 0; /* 내부에서 패딩 관리 */
            height: 800px;
            max-height: 800px;
            overflow-y: auto;
            background-color: rgba(20,20,20,0.8);
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            position: relative; /* 자식 요소의 absolute 기준 */
        }
        #scrollSpacer {
            position: relative;
            width: 100%;
            z-index: 1;
        }
        #visibleItemsWrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 20px; /* 아이템 주변의 여백 */
            box-sizing: border-box;
            z-index: 2;
        }

		.result-item {
			margin-bottom: 15px;
			padding: 12px 20px;
			background: linear-gradient(135deg, #202228, #1a1c20);
			cursor: pointer;
			transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
			border-radius: 12px;
			border: 1px solid rgba(255, 255, 255, 0.1);
			box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 2px rgba(0,0,0,0.4);
			display: flex;
			align-items: center;
			justify-content: space-between;
			flex-wrap: nowrap;
			gap: 15px;
			position: relative;
			overflow: hidden;
		}
		.result-item::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			width: 4px;
			height: 100%;
			background: linear-gradient(180deg, #ff4081, #f50057);
			opacity: 0.6;
			transition: opacity 0.3s;
		}

		.item-images {
			display: flex;
			align-items: center;
			flex-wrap: nowrap;
			gap: 8px;
            flex-grow: 1;
            overflow-x: auto;
            padding: 5px 0;
            margin: -5px 0;
            scrollbar-width: none;
		}
        .item-images::-webkit-scrollbar {
            display: none;
        }
		.result-info-right {
			display: flex;
			align-items: center;
			flex-shrink: 0;
		}
        .small-character-img {
            height: 50px;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .small-character-img.rare {
            border: 2px solid #ff9800;
            box-shadow: 0 0 8px rgba(255,152,0,0.6);
        }
        .small-character-img.super-rare {
            border: 2px solid #D32F2F;
            box-shadow: 0 0 8px rgba(211, 47, 47, 0.6);
        }
        .image-with-count-container {
            position: relative;
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }
		.image-count-badge {
		    position: absolute;
		    bottom: -4px;
		    right: -4px; 
		    min-width: 18px;
		    text-align: center;
		    background: rgba(0, 0, 0, 0.75);
		    backdrop-filter: blur(4px);
		    color: #fff;
		    padding: 1px 6px;
		    border-radius: 8px; 
		    font-family: 'Poppins', sans-serif;
		    font-size: 13px; 
		    font-weight: 600;
		    line-height: 1.4;
		    border: 1px solid rgba(255, 255, 255, 0.1);
		    box-shadow: 0 2px 5px rgba(0,0,0,0.6); 
		    pointer-events: none;
		}
		.image-count-badge.rare-badge {
		    color: #ffc107;
		    text-shadow: 0 0 5px rgba(255, 193, 7, 0.7);
		}
		.image-count-badge.super-rare-badge {
		    color: #ff5252;
		    text-shadow: 0 0 5px rgba(255, 82, 82, 0.7);
		}
        .item-box {
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 70px;
            height: 60px;
            background: linear-gradient(145deg, #4d3e00, #332a00);
            border: 2px solid #ffc107;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.6), 0 2px 4px rgba(0,0,0,0.3), inset 0 0 5px rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            flex-shrink: 0;
        }
        .item-box .item-title {
            color: #ffc107;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            margin-bottom: 4px;
        }
        .item-box .item-count {
            color: #fff;
            font-size: 12px;
            font-weight: 600;
        }
        .price-box {
			display: flex;
            flex-direction: column;
			justify-content: center;
			align-items: flex-end;
			height: 50px;
			min-width: 95px;
			padding: 0 10px;
			background: linear-gradient(270deg, rgba(39, 174, 96, 0.2), transparent);
			border-radius: 8px;
			font-family: 'Poppins', sans-serif;
		}
        .price-box .price-krw {
			font-size: 18px;
			font-weight: 700;
			color: #2ecc71;
			text-shadow: 0 0 8px rgba(46, 204, 113, 0.5);
		}
        .price-box .price-label {
			font-size: 12px;
			color: #bdc3c7;
            opacity: 0.7;
		}
        .scroll-indicator {
            position: absolute;
            right: 125px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            transition: opacity 0.2s;
        }
        .item-images.has-scroll + .scroll-indicator {
            display: flex;
        }
        .item-images.scrolled-to-end + .scroll-indicator {
            opacity: 0;
            pointer-events: none;
        }

        #tsparticles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(18,18,18,0.95);
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            z-index: 2000; transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #loader.hidden { opacity: 0; visibility: hidden; }
        .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid #ff4081; border-radius: 50%;
            width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #budgetContainer, #filterButton, .character-grid, h1, #copyInstruction { z-index: 5; position: relative; }

		.extras-box {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 50px;
			min-width: 70px;
			padding: 0 10px;
			background: rgba(176, 176, 176, 0.1);
			border: 1px dashed rgba(176, 176, 176, 0.5);
			border-radius: 8px;
			cursor: pointer;
			transition: background 0.2s, border-color 0.2s;
            flex-shrink: 0;
		}
		.extras-box .item-title {
			color: #e0e0e0;
			font-size: 14px;
			text-decoration: none;
			font-weight: bold;
		}
		#extrasPopup {
			display: none; position: fixed; z-index: 4000; left: 0; top: 0;
			width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
            align-items: center; justify-content: center;
		}
		.extras-popup-content {
			background-color: #1e1e1e; padding: 25px; border: 2px solid #b0b0b0;
			border-radius: 15px; width: 80%; max-width: 700px; box-shadow: 0 5px 25px rgba(0,0,0,0.7);
			position: relative;
		}
		.close-button {
			color: #aaa; position: absolute; top: 10px; right: 15px;
			font-size: 28px; font-weight: bold; cursor: pointer;
		}
		.close-button:hover, .close-button:focus { color: #fff; }
		#extras-popup-grid {
			display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding-top: 10px;
		}

        @media (max-width: 768px) {
            .character-grid { grid-template-columns: repeat(auto-fill, minmax(80px,1fr)); gap: 10px; }
            .character-box { height: 125px; padding: 8px; }
            .character-box .character-img { width: 60px; height: 70px; margin-bottom: 5px; }
            .character-box .character-name { font-size: 14px; }
            .spinbox-container input[type="number"] { width: 45px; }
            #filterButton { font-size: 16px; padding: 12px; }
            
            #visibleItemsWrapper { padding: 10px; }
            .result-item { flex-wrap: wrap; }
            .item-images { flex-basis: 100%; }
            .result-info-right { flex-basis: 100%; justify-content: flex-end; }
			.price-box, .extras-box { flex-grow: 1; justify-content: center;}
            .price-box { align-items: center; }
			.small-character-img, .price-box, .extras-box { height: 45px; }
            .item-images { gap: 5px; }

            #copyInstruction { font-size: 1em; }
            #copyMessage { font-size: 1em; padding: 15px 20px; }
            .item-box { width: 55px; height: 45px; }
            .item-box .item-title { font-size: 10px; margin-bottom: 0; }
            .extras-box .item-title { font-size: 12px; }
            .item-box .item-count { font-size: 12px; }
            .price-box .price-krw { font-size: 16px; }
            .price-box .price-label { display: none; }
            .scroll-indicator { display: none !important; }
            .extras-popup-content { width: 90%; padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    <div id="tsparticles"></div>
    <h1>영웅전설: 가가브 트릴로지</h1>
    <div class="character-grid" id="characterGrid"></div>
    <div id="budgetContainer">
        <!-- Budget Box HTML is unchanged -->
    </div>
    <button id="filterButton">필터 적용</button>
    <div id="copyInstruction">※ 클릭하면 물품 코드가 복사됩니다<br>※ 실제 계정에는 일부 캐릭터가 없고, 대신 전설선택권6장 & 3성선택권2장이 있습니다</div>
    <div id="results"></div>
    <div id="copyMessage">복사되었습니다</div>

    <div id="extrasPopup">
		<div class="extras-popup-content">
			<span class="close-button" id="closeExtrasPopup">×</span>
			<div id="extras-popup-grid"></div>
		</div>
	</div>

    <script>
        // ... (초반 로직 및 캐릭터/데이터 관련 변수 선언은 동일) ...
        let lastActivityTime = Date.now();
        // ... (나머지 로직도 대부분 동일) ...

        // =================================================================
        // [추가] 가상 스크롤 관련 변수
        // =================================================================
        let currentDisplayKeys = [];
        const ITEM_HEIGHT = 90; // .result-item의 높이(75) + margin-bottom(15)
        const VISIBLE_ITEMS_BUFFER = 5; // 화면 밖 위/아래로 미리 렌더링할 아이템 수
        let resultsContainer = null;
        let visibleItemsWrapper = null;
        let scrollSpacer = null;
        let lastRenderedStartIndex = -1;
        let lastRenderedEndIndex = -1;

        // ... (다른 함수들은 대부분 동일) ...
        
        function filterData() {
            // 필터링 로직은 동일
            let filtered = {};
            for(const [k, v] of Object.entries(luaData)) {
                const chars = v.match(/.{1,3}/g)||[];
                if(checkConditions(chars)) filtered[k] = v;
            }
    
            const budgetSelected = budgetBox.classList.contains('selected');
            if (budgetSelected) {
                const budgetValue = parseFloat(budgetInput.value);
                if (!isNaN(budgetValue) && budgetValue > 0) {
                    const minPrice = budgetValue * 0.65;
                    const maxPrice = budgetValue * 1.35;
                    filtered = Object.fromEntries(
                        Object.entries(filtered).filter(([key]) => {
                            const price = getPrice(key);
                            return price >= minPrice && price <= maxPrice;
                        })
                    );
                }
            }
            
            const sortedKeys = Object.keys(filtered).sort((a, b) => {
                if (budgetSelected) {
                    return getSelectedCharacterSum(filtered[b]) - getSelectedCharacterSum(filtered[a]);
                }
                return getPrice(b) - getPrice(a);
            });
            
            // displayResults 대신 새로운 가상 스크롤 초기화 함수 호출
            setupVirtualScroll(sortedKeys);
        }

        function setupVirtualScroll(sortedKeys) {
            currentDisplayKeys = sortedKeys;
            resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = ''; // 기존 내용 모두 제거

            scrollSpacer = document.createElement('div');
            scrollSpacer.id = 'scrollSpacer';
            scrollSpacer.style.height = `${currentDisplayKeys.length * ITEM_HEIGHT}px`;

            visibleItemsWrapper = document.createElement('div');
            visibleItemsWrapper.id = 'visibleItemsWrapper';
            
            resultsContainer.appendChild(scrollSpacer);
            resultsContainer.appendChild(visibleItemsWrapper);

            // 이벤트 리스너가 중복되지 않도록 한 번만 설정
            resultsContainer.onscroll = () => {
                window.requestAnimationFrame(renderVisibleItems);
            };

            // 초기 렌더링
            renderVisibleItems();
        }
        
        function renderVisibleItems() {
            if (!resultsContainer || currentDisplayKeys.length === 0) return;

            const scrollTop = resultsContainer.scrollTop;
            const viewportHeight = resultsContainer.clientHeight;

            const startIndex = Math.max(0, Math.floor(scrollTop / ITEM_HEIGHT) - VISIBLE_ITEMS_BUFFER);
            const endIndex = Math.min(currentDisplayKeys.length, Math.ceil((scrollTop + viewportHeight) / ITEM_HEIGHT) + VISIBLE_ITEMS_BUFFER);
            
            // 이미 렌더링된 범위와 같으면 아무것도 하지 않음
            if (startIndex === lastRenderedStartIndex && endIndex === lastRenderedEndIndex) {
                return;
            }

            lastRenderedStartIndex = startIndex;
            lastRenderedEndIndex = endIndex;
            
            visibleItemsWrapper.innerHTML = ''; // 보이는 아이템 래퍼만 비움
            
            const fragment = document.createDocumentFragment();

            for (let i = startIndex; i < endIndex; i++) {
                const k = currentDisplayKeys[i];
                // 아이템 생성 로직은 displayResults에서 가져옴
                const item = createResultItem(k, luaData[k]);
                if (item) {
                    fragment.appendChild(item);
                }
            }
            
            visibleItemsWrapper.appendChild(fragment);
            visibleItemsWrapper.style.transform = `translateY(${startIndex * ITEM_HEIGHT}px)`;
            
            setupScrollIndicators(visibleItemsWrapper.querySelectorAll('.result-item'));
        }

        function createResultItem(k, v) {
            const val = sortedData[k];
            if (!val) return null;

            const item = document.createElement('div');
            item.className = 'result-item';
            item.dataset.itemKey = k;
            item.addEventListener('click', (e) => {
                if (e.target.closest('.extras-box') || e.target.classList.contains('scroll-indicator')) return;
                copyToClipboard(item);
            });

            const leftSection = document.createElement('div');
            leftSection.className = 'item-images';

            const rightSection = document.createElement('div');
            rightSection.className = 'result-info-right';

            const price = getPrice(k);
            const [originalChars] = val.split('=').map(s => s.trim());
            
            const allCharImages = [];
            const extraCharImages = [];
            const fixedItemsInfo = [
                { name: '태테르', countText: '50+' }, { name: '달증', countText: '100+' }, 
                { name: '빵', countText: '1500+' }, { name: '소환권', countText: '1000+' }
            ];

            originalChars.split(' ').forEach(it => {
                const m = it.match(/([가-힣]+)(\d*)/);
                if (m) {
                    const [_, name, cnt] = m;
                    const rep = cnt ? parseInt(cnt) : 1;
                    const charInfo = characters.find(([_, kor]) => kor === name);
                    if (charInfo) {
                         const imageData = {
                            src: `cropped_characters/${name}.png`, alt: name, engName: charInfo[0], count: rep
                        };
                        if (exceptCharacters.includes(charInfo[0]) || tierCharacters.includes(charInfo[0])) {
                            allCharImages.push(imageData);
                        } else {
                            extraCharImages.push(imageData);
                        }
                    }
                }
            });
            
            allCharImages.forEach(charData => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-with-count-container';

                const img = document.createElement('img');
                img.src = charData.src; img.alt = charData.alt;
                img.className = 'small-character-img';

                let badgeClass = '';
                if (exceptCharacters.includes(charData.engName)) {
                    img.classList.add('super-rare');
                    badgeClass = 'super-rare-badge';
                } else if (tierCharacters.includes(charData.engName)) {
                    img.classList.add('rare');
                    badgeClass = 'rare-badge';
                }
                imgContainer.appendChild(img);

                if (charData.count > 1) {
                    const badge = document.createElement('div');
                    badge.className = `image-count-badge ${badgeClass}`;
                    badge.textContent = `x${charData.count}`;
                    imgContainer.appendChild(badge);
                }
                leftSection.appendChild(imgContainer);
            });

            const extrasContent = extraCharImages.map(imgData => ({ type: 'char', ...imgData }));
            fixedItemsInfo.forEach(item => {
                extrasContent.push({ type: 'item', title: item.name, count: item.countText });
            });

            if (extrasContent.length > 0) {
                const extrasBox = document.createElement('div');
                extrasBox.className = 'extras-box';
                extrasBox.innerHTML = `<div class="item-title">기타</div>`;
                extrasBox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showExtrasPopup(extrasContent);
                });
                leftSection.appendChild(extrasBox);
            }
            
            const priceBox = document.createElement('div');
            priceBox.className = 'price-box';
            priceBox.innerHTML = `<div class="price-krw">₩${price.toLocaleString()}</div><div class="price-label">가격</div>`;
            rightSection.appendChild(priceBox);

            const scrollIndicator = document.createElement('div');
            scrollIndicator.className = 'scroll-indicator';
            scrollIndicator.innerHTML = '...';
            
            item.appendChild(leftSection);
            item.appendChild(scrollIndicator);
            item.appendChild(rightSection);

            return item;
        }

        function setupScrollIndicators(itemsToSetup) {
            itemsToSetup.forEach(item => {
                const imagesContainer = item.querySelector('.item-images');
                const scrollIndicator = item.querySelector('.scroll-indicator');

                requestAnimationFrame(() => {
                    const hasScroll = imagesContainer.scrollWidth > imagesContainer.clientWidth;
                    if (hasScroll) {
                        imagesContainer.classList.add('has-scroll');

                        scrollIndicator.onclick = (e) => {
                            e.stopPropagation();
                            imagesContainer.scroll({ left: imagesContainer.scrollWidth, behavior: 'smooth' });
                            imagesContainer.classList.add('scrolled-to-end');
                        };

                        item.onmouseleave = () => {
                            if (imagesContainer.classList.contains('scrolled-to-end')) {
                                imagesContainer.scroll({ left: 0, behavior: 'smooth' });
                                imagesContainer.classList.remove('scrolled-to-end');
                            }
                        };
                        
                        imagesContainer.onscroll = () => {
                            if (imagesContainer.scrollLeft + imagesContainer.clientWidth >= imagesContainer.scrollWidth - 1) {
                                imagesContainer.classList.add('scrolled-to-end');
                            } else if (imagesContainer.classList.contains('scrolled-to-end')) {
                                imagesContainer.classList.remove('scrolled-to-end');
                            }
                        };
                    }
                });
            });
        }
        
        function resetAllScrolledItems() {
             document.querySelectorAll('.item-images.scrolled-to-end').forEach(container => {
                container.scroll({ left: 0, behavior: 'smooth' });
                container.classList.remove('scrolled-to-end');
            });
        }
        
        // ... (copyToClipboard, showCopyMessage, getSelectedCharacters 등 나머지 함수는 동일) ...
        function showExtrasPopup(content) {
			const popup = document.getElementById('extrasPopup');
			const grid = document.getElementById('extras-popup-grid');
			grid.innerHTML = '';

			content.forEach(item => {
                if (item.type === 'char') {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'image-with-count-container';
                    
                    const img = document.createElement('img');
                    img.src = item.src;
                    img.alt = item.alt;
                    img.className = 'small-character-img';
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    imgContainer.appendChild(img);

                    if (item.count > 1) {
                        const badge = document.createElement('div');
                        badge.className = 'image-count-badge';
                        badge.textContent = `x${item.count}`;
                        imgContainer.appendChild(badge);
                    }
                    grid.appendChild(imgContainer);

                } else if (item.type === 'item') {
                    const box = document.createElement('div');
                    box.className = 'item-box';
                    box.innerHTML = `<div class="item-title">${item.title}</div><div class="item-count">${item.count}</div>`;
                    grid.appendChild(box);
                }
			});
			popup.style.display = 'flex';
		}
        
        function copyToClipboard(el) {
            const itemKey = el.dataset.itemKey;
            if (!itemKey) return;
            const textToCopy = sortedData[itemKey] || itemKey;
            navigator.clipboard.writeText(textToCopy).then(() => showCopyMessage(), err => console.error('복사 실패: ', err));
        }

        function showCopyMessage(){
            const msg = document.getElementById('copyMessage');
            msg.classList.add('show');
            setTimeout(() => { msg.classList.remove('show'); }, 2000);
        }

        function getSelectedCharacters(){
            let result = '';
            if(budgetBox.classList.contains('selected')) {
                result = budgetInput.value ? `${budgetInput.value} - ` : "nil - ";
            }
            result += [...document.getElementsByClassName('character-box')]
                .filter(b => b.classList.contains('selected'))
                .map(b => `${b.dataset.engName}:${b.querySelector('input').value}`)
                .join(',');
            return result;
        }
        
        document.getElementById('filterButton').addEventListener('click', () => {
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            loadData().then(() => { 
                filterData(); 
                gtag('event', 'apply_filter', { 'selected_characters': getSelectedCharacters() });
            }).catch(error => { console.error('필터 적용 에러:', error); });
        });

        document.addEventListener('DOMContentLoaded', () => {
            // ... 기존 DOMContentLoaded 내용 동일 ...
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.result-item') && !e.target.classList.contains('scroll-indicator')) {
                    resetAllScrolledItems();
                }
            });
            const resContainer = document.getElementById('results');
            if(resContainer) resContainer.addEventListener('scroll', resetAllScrolledItems);
        });
    </script>
</body>
</html>

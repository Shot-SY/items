<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Filter</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .character-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .character-box { border: 1px solid #ccc; padding: 10px; text-align: center; }
        button { display: block; width: 100%; padding: 10px; margin-bottom: 10px; }
        #results { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Character Filter</h1>
    <div id="characterGrid" class="character-grid"></div>
    <button onclick="filterData()">Filter</button>
    <div id="dataCount">Data Count: 0 / 0</div>
    <div id="results"></div>

    <script>
        const characters = [
            "ervin", "gerd", "myle", "thomas", "shannon", "hwiri", "guse", "elenoa", "imel", "gawain",
            "aida", "sarah", "aria", "muse", "rachel", "varius", "palman", "luthis",
            "madram", "mitchell", "rookius", "volgade"
        ];

        let sortedData = {};
        let luaData = {};

        // 캐릭터 체크박스와 스핀박스 생성
        const characterGrid = document.getElementById('characterGrid');
        characters.forEach(char => {
            const charBox = document.createElement('div');
            charBox.className = 'character-box';
            charBox.innerHTML = `
                <label>
                    <input type="checkbox" id="${char}-check" onchange="toggleSpinbox('${char}')">
                    ${char}
                </label>
                <br>
                <input type="number" id="${char}-spin" min="0" max="9" value="0" disabled>
            `;
            characterGrid.appendChild(charBox);
        });

        function toggleSpinbox(char) {
            const checkbox = document.getElementById(`${char}-check`);
            const spinbox = document.getElementById(`${char}-spin`);
            spinbox.disabled = !checkbox.checked;
            spinbox.value = checkbox.checked ? 1 : 0;
        }

        // 데이터 로드
        Promise.all([
            fetch('sorted_data_with_keys.txt').then(response => response.text()),
            fetch('data.lua').then(response => response.text())
        ]).then(([sortedDataText, luaDataText]) => {
            // sorted_data_with_keys.txt 처리
            sortedDataText.split('\n').forEach(line => {
                const [key, ...rest] = line.trim().split(' ');
                if (key && rest.length > 0) sortedData[key] = rest.join(' ');
            });

            // data.lua 처리
            const dataMatch = luaDataText.match(/data\s*=\s*{([^}]+)}/);
            if (dataMatch) {
                dataMatch[1].split(',').forEach(item => {
                    const [key, value] = item.trim().split('=').map(s => s.trim().replace(/['"]/g, ''));
                    if (key && value) luaData[key] = value;
                });
            }

            updateDataCount(Object.keys(luaData).length, Object.keys(luaData).length);
            console.log('Data loaded:', {sortedData, luaData});
        }).catch(error => console.error('Error loading data:', error));

        function updateDataCount(filtered, total) {
            document.getElementById('dataCount').textContent = `Data Count: ${filtered} / ${total}`;
        }

        function filterData() {
            const filteredData = Object.entries(luaData).filter(([key, value]) => {
                const chars = value.match(/.{1,3}/g) || [];
                return characters.every(char => {
                    const checkbox = document.getElementById(`${char}-check`);
                    if (checkbox.checked) {
                        const requiredCount = parseInt(document.getElementById(`${char}-spin`).value);
                        const actualCount = chars.filter(c => c.startsWith(char.slice(0, 2)))
                                                 .reduce((sum, c) => sum + parseInt(c[2]), 0);
                        return actualCount >= requiredCount;
                    }
                    return true;
                });
            });

            displayResults(filteredData);
            updateDataCount(filteredData.length, Object.keys(luaData).length);
        }

        function displayResults(filteredData) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = filteredData.map(([key, value]) => {
                // sortedData에서 해당 키의 값을 찾아 표시, 없으면 원래 값을 표시
                const displayValue = sortedData[key] || value;
                return `<p>${key} ${displayValue}</p>`;
            }).join('');
        }
    </script>
</body>
</html>
